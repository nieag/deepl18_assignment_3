

%%% Subfunctions

function [X, Y, y] = LoadBatch(filename)
dataSet = load(filename);
X = double(dataSet.data)'/255;
y = double(dataSet.labels+1)';
N = length(y);
K = max(y);
Y = zeros(K, N);
for i = 1:N
    Y(y(i), i) = 1;
end
end

function [P, X, S] = EvaluateClassifier(X0, W, b, K)
S = {};
X = {X0};

for i=2:K-1
    S{i} = bsxfun(@plus, W{i}*X{i}, b{i});
    X{i} = max(0, S{i}); % ReLU activation
end
S{K} = bsxfun(@plus, W{K}, b{K});
P = softmax(S{K});
end

function [b_grad, W_grad] = ComputeGradients(X, Y, W, b, lambda, GDparams)
N = size(X,2);
[P, X, S] = EvaluateClassifier(X, W, b, GDparams);
b_grad = {};
W_grad = {};
for i=1:N
    g = -(Y(:,i)-P(:,i))';
    
    for k=K:1
        b_grad{k} = g/N;
        W_grad{k} = g'*X{k}(:,i)/N + 2*lambda*W{k};
        g = g*W{k};
        g = g*diag(S{k}(:,i)>0);
    end
end

% b_grad = {dldb1/N, dldb2/N};
% W_grad = {dldw1/N + 2*lambda*W{1}, dldw2/N + 2*lambda*W{2}};
end